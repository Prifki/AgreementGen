var querystring = require("querystring");var jsonfile = require('jsonfile');var fs = require('fs');function makeSSID() {	return Math.random().toString(36).substring(7);}function saveSSID(newSSID){	var file = 'ssid.json';	var toPrint=newSSID;	jsonfile.writeFile(file, toPrint, function (err) {		if(err) console.error(err);	})}function start(request, response, postData) {var generate_content = require('./static/generate_content');var header_content = require('./static/header_content');var client_scripts = require('./logic/client_scripts');var abits_file = 'abits.json';var ssid_file = 'ssid.json';ssid=jsonfile.readFileSync(ssid_file);abits=jsonfile.readFileSync(abits_file);var napr=[];  function parseCookies(request) {    var list = {};	if(request.headers.cookie) {		var rc = request.headers.cookie;		rc && rc.split(';').forEach(function( cookie ) {			var parts = cookie.split('=');			list[parts.shift().trim()] = decodeURI(parts.join('='));		});	}    return list;  }  if(parseCookies(request).SSID)	var cookie=parseCookies(request).SSID;  else	var cookie='none';  console.log("Request handler 'start' was called.");    if (cookie==ssid) {		  function napravlen(value_kaf){			switch(value_kaf){				case "1":text_kaf = '09.03.01';break;				case "2":text_kaf = '09.03.01';break;				case "3":text_kaf = '09.03.02';break;				case "4":text_kaf = '09.03.02';break;				case "5":text_kaf = '09.03.04';break;				case "6":text_kaf = '09.03.04';break;				case "7":text_kaf = '10.03.01';break;				case "8":text_kaf = '10.03.01';break;				case "9":text_kaf = '11.03.03';break;				case "10":text_kaf = '12.03.01';break;				case "11":text_kaf = '12.03.01';break;				case "12":text_kaf = '13.03.02';break;				case "13":text_kaf = '15.03.06';break;				case "14":text_kaf = '15.03.06';break;				case "15":text_kaf = '15.03.06';break;				case "16":text_kaf = '27.03.04';break;				case "17":text_kaf = '27.03.04';break;				case "18":text_kaf = '44.03.04';break;				case "19":text_kaf = '09.03.01';break;				case "20":text_kaf = '10.03.01';break;				case "21":text_kaf = '10.03.01';break;					case "22":text_kaf = '12.03.01';break;				case "23":text_kaf = '27.03.04';break;			};			return text_kaf;		}		  for (var i=0;i<abits.length;i++){				napr[i]=napravlen(abits[i].speciality);			}		  var body = '<!doctype html>'		+'<html>'		+'<head>'		+'	<script>'		+'var abits = new Object([';		for (var i=0;i<abits.length;i++)			body+='{"dogovor":"'+abits[i].dogovor+'","srok":"'+abits[i].srok+'","fio":"'+abits[i].fio+'","speciality":"'+abits[i].speciality+'","serial":"'+abits[i].serial+'","number":"'+abits[i].number+'","vydan":"'+abits[i].vydan+'","data_vyd":"'+abits[i].data_vyd+'","code_podrazd":"'+abits[i].code_podrazd+'","adres_reg":"'+abits[i].adres_reg+'","tel":"'+abits[i].tel+'","n_sem_oplaty":"'+abits[i].n_sem_oplaty+'","group_n":"'+abits[i].group_n+'","fio_zak":"'+abits[i].fio_zak+'","serial_zak":"'+abits[i].serial_zak+'","number_zak":"'+abits[i].number_zak+'","vydan_zak":"'+abits[i].vydan_zak+'","data_vyd_zak":"'+abits[i].data_vyd_zak+'","code_podrazd_zak":"'+abits[i].code_podrazd_zak+'","adres_reg_zak":"'+abits[i].adres_reg_zak+'","tel_zak":"'+abits[i].tel_zak+'"},';		body+=']);'		+ client_scripts.scr_content		+'	</script>'		+ header_content.header		+'</head>'		+'<body>'		+'		<div class="bloc l-bloc bgc-white" id="bloc-0">'		+'			  <div class="col-sm-6" style="position:absolute;top:0px;bottom:0;left:0;overflow-y:scroll;">'		+'				<div class="sidebar-nav">'		+'			  <h3 align="center">Готовые договоры</h3>'		+'			  <ul class="nav nav-pills nav-stacked" style="font-size: 11px;" align="center">'				+'<li><table width="100%" style="font-size: 11px;"><tr align="center"><td width="8%"><label>Договор</label></td><td width="25%"><label>ФИО абитуриента</label></td><td width="25%"><label>ФИО заказчика</label></td><td width="10%"><label>Направление</label></td><td width="10%"><label>Телефон</label></td><td width="22%"></td></tr></table></li>';		for (var i=0;i<abits.length;i++)			body += '<li id="'+abits[i].dogovor+'" onclick="inputUpdate('+i+')"><a href="#" style="padding:3px;"><table width="100%"><tr><td width="8%">'+abits[i].dogovor+'</td><td width="25%">'+abits[i].fio+'</td><td width="25%">'+abits[i].fio_zak+'</td><td width="10%">'+napr[i]+'</td><td width="10%">'+abits[i].tel+'</td><td width="22%"><input style="margin-left: 10px;" type="button" onclick="inputUpdate('+i+'),document.forms[0].submit()" value="Сохранить"></td></tr></table>'			//+'<input type="button" class="btn" onclick="inputUpdate('+i+'),document.forms[0].submit()" value="Сохранить">			+'</a></li>';		body+=generate_content.content		+'</html>'		+'';			response.writeHead(200, {"Content-Type": "text/html"});			response.write(body);			response.end();	}	else {		response.writeHead(301, {"Location": "/auth"});		response.end();	}}function generate(request, response, postData) {  console.log("Request handler 'generate' was called.");  if (request.headers.referer=='http://localhost:8888/start') {	  var generator = require('./logic/generator');	  var sqlite = require('./logic/sqlite');	  generator.gen(postData);	  sqlite.dbAdd(postData);	  response.writeHead(200, {"Content-Type": "text/html"});	  response.write(generator.body);	  response.end();  }  else {	  response.writeHead(301, {'Set-Cookie': 'SSID='+'none', "Location": '/auth'});	  response.end();  }}function auth(request, response, postData) {  console.log("Request handler 'auth' was called.");  var auth_body = require('./static/auth_body');  response.writeHead(200, {"Content-Type": "text/html"});  response.write(auth_body.body);  response.end();}function checking(request, response, postData) {  console.log("Request handler 'checking' was called.");	var crypto = require('crypto');  if (crypto.createHash('md5').update(querystring.parse(postData).pass).digest('hex')=='f67169dfbf72c4ca285e9ee12e3e9ac5'){  	  var ssid=makeSSID();	  saveSSID(ssid);	  response.writeHead(301, {"Content-Type": "text/html", 'Set-Cookie': 'SSID='+ssid, 'Location': 'start'});	  response.end();  }  else {	  response.writeHead(301, {"Location": '/auth'});	  response.end();  }}function logout(request, response, postData) {  console.log("Request handler 'logout' was called.");  var ssid=makeSSID();  saveSSID(ssid);  response.writeHead(301, {"Location": "/auth"});  response.end();}exports.start = start;exports.generate = generate;exports.auth = auth;exports.checking = checking;exports.logout = logout;  